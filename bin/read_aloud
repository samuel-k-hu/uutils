#!/usr/bin/perl

use strict;
use warnings;

use Getopt::Std qw(getopts);
use List::Util  qw/shuffle/;
use Digest::SHA qw(sha256_hex);
use File::Spec;
use File::Copy;
use Cwd qw( abs_path );

if ($^O eq 'MSWin32') {
    require Win32;
    Win32::SetConsoleOutputCP(65001);
}

my %opts;
my $fh;
my $audio_dir;
my @list = ();

getopts( 'qcrt:a:x:n:', \%opts );

if ( $opts{'t'} ) {
    open $fh, '<', $opts{'t'};
}
else {
    open $fh, '<-';
}

if ( $opts{'a'} ) {
    $audio_dir = $opts{'a'};
}
elsif ( -e 'audio' ) {
    $audio_dir = 'audio';
}
else {
    die;
}

while (<$fh>) {
    chomp;
    next if /^#/;
    push @list, $_;
}

@list = shuffle @list if $opts{'r'};
@list = @list[($#list -($opts{'n'} - 1)..$#list)] if $opts{'n'} && $opts{'n'} <= $#list;

foreach (@list) {
    my $mp3 = File::Spec->catfile( abs_path($audio_dir),
        substr( sha256_hex($_), 0, 16 ) . ".mp3" );
    if ( $opts{'x'} ) {
        my $x_dir = abs_path($opts{'x'});
        copy($mp3, $x_dir) or warn  "Copy $mp3 failed: $!";
    }
    elsif ($opts{'c'}) {
       -f $mp3 or warn "$_ : $mp3";
    }
    else {
        my $start = time();
        print "$_\n";
        system 'mpg123', '-q', $mp3;
        my $elapsed = time() - $start;
        next if $opts{'q'};
        if ( $elapsed < 1 ) {
            sleep(1);
        }
        else {
            sleep( $elapsed + 0.5 );
        }
    }
}
